<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Slideshow Player</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        #slideshow-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000; /* Optional: Set a background color in case the image aspect ratio doesn't match the screen */
        }

        #slideshow-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div id="slideshow-container">
        <!-- Images will be displayed here -->
    </div>

    <script>
        var imageUrls = [];
        var currentIndex = 0;
        var timer;
        var timeCheckInterval;
        var currentSettings = null;

        function loadSettings() {
            fetch('settings.txt')
                .then(response => response.text())
                .then(data => {
                    var settings = parseSettings(data);
                    currentSettings = settings; // Store the current settings
                    startSlideshow(settings);
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Einstellungen: ', error);
                });
        }

        function parseSettings(data) {
        var settings = {};
        var lines = data.trim().split('\n');
        lines.forEach(line => {
            var parts = line.split(':');
            var key = parts[0].trim();
            var value = parts.slice(1).join(':').trim(); // Rejoin the time fields in case they contain ':'
            settings[key] = value;
        });
        return settings;
        }

        function loadFileOrder() {
            fetch('file_order.txt')
                .then(response => response.text())
                .then(data => {
                    imageUrls = parseFileOrder(data);
                    if (imageUrls.length > 0) {
                        showNextImage();
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Dateireihenfolge: ', error);
                });
        }

        function parseFileOrder(data) {
            var lines = data.trim().split('\n');
            return lines;
        }

        function startSlideshow(settings) {
            var startHour = parseInt(settings.start_time.split(':')[0]);
            var endHour = parseInt(settings.end_time.split(':')[0]);
            var currentHour = new Date().getHours();

            if (currentHour >= startHour && currentHour < endHour) {
                loadFileOrder();
                var duration = parseInt(settings.duration);
                timer = setInterval(showNextImage, duration);
            } else {
                // Outside the specified time window, check every minute if time window changed
                timeCheckInterval = setInterval(function () {
                    loadSettings();
                    checkTimeWindow(settings);
                }, 60000); // Check every minute
            }
        }

        function checkTimeWindow(settings) {
            var startHour = parseInt(settings.start_time.split(':')[0]);
            var endHour = parseInt(settings.end_time.split(':')[0]);
            var currentHour = new Date().getHours();

            if (currentHour >= startHour && currentHour < endHour) {
                clearInterval(timeCheckInterval);
                loadFileOrder();
                var duration = parseInt(settings.duration);
                timer = setInterval(showNextImage, duration);
            }
        }

        function showNextImage() {
          if (currentIndex >= imageUrls.length) {
                // Reached the end of the cycle, check for updates
                checkForUpdates(currentSettings);
                currentIndex = 0; // Start from the beginning after reaching the end
            }

            var imageUrl = 'content/' + imageUrls[currentIndex];
            var img = new Image();
            img.src = imageUrl;
            img.onload = function () {
                // Display the image in the slideshow container
                var slideshowContainer = document.getElementById('slideshow-container');
                slideshowContainer.innerHTML = ''; // Clear previous images
                slideshowContainer.appendChild(img);
            };

            currentIndex++;
        }

        function checkForUpdates(settings) { // Receive the current settings as an argument
        // Check for updates in the image order (file_order.txt)
        fetch('file_order.txt')
            .then(response => response.text())
            .then(data => {
                var newImageUrls = parseFileOrder(data);
                var imageOrderChanged = !arraysEqual(imageUrls, newImageUrls);

                // Check for updates in the settings (settings.txt)
                fetch('settings.txt')
                    .then(response => response.text())
                    .then(settingsData => {
                        var newSettings = parseSettings(settingsData);
                        var settingsChanged = !objectsEqual(settings, newSettings);

                        if (imageOrderChanged || settingsChanged) {
                            // If the image order or settings have changed, restart the slideshow with the new data
                            clearInterval(timer);
                            clearInterval(timeCheckInterval);
                            imageUrls = newImageUrls;
                            currentSettings = newSettings; // Update the current settings
                            startSlideshow(currentSettings);
                        }
                    })
                    .catch(error => {
                        console.error('Fehler beim Laden der Einstellungen: ', error);
                    });
            })
            .catch(error => {
                console.error('Fehler beim Laden der Dateireihenfolge: ', error);
            });
        }

        // Helper function to compare two arrays
        function arraysEqual(arr1, arr2) {
            return JSON.stringify(arr1) === JSON.stringify(arr2);
        }

        // Helper function to compare two objects
        function objectsEqual(obj1, obj2) {
            return JSON.stringify(obj1) === JSON.stringify(obj2);
        }

        // Start the slideshow when the page loads
        loadSettings();
    </script>
</body>
</html>
