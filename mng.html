<!DOCTYPE html>
<html lang="de">
<head>
    <!-- File Management by Felix Salzer for tabbs vital GmbH 2023 -->
    <meta charset="UTF-8">
    <title>File Management</title>
    <link rel="stylesheet" href="style.css">
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"> -->
    <script src="https://kit.fontawesome.com/91b23fae0d.js" crossorigin="anonymous"></script>
</head>
<body>
<header>
    <nav>
        <a><img src="tabbs_Tabbs Hauptlogo.png" alt="Tabbs Logo" id="logo"></a> <!-- Logo einfügen -->
        <a class="active" href="mng.html"> Digital Signage File Management</a>
        <a href="index.html" target="_blank">Player</a>
        <a href="https://tabbs.de" target="_blank">tabbs.de</a>
    </nav>
</header>
<main>
    <h1>Dateien für Digital Signage Screens verwalten</h1>
    <div>
    <h2>Aktuelle Dateien:</h2>
    <button onclick="galleryView()"><i class="fa-solid fa-grip"></i></button>
    <button onclick="listView()"><i class="fa-solid fa-ellipsis"></i></button>
    </div>
    <div id="file-list">
        <!-- Die Liste der Dateien wird hier als Bilder mit Beschriftung und Löschen-Icon angezeigt -->
    </div>

    <h2>Neue Datei hochladen:</h2>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="file" id="file-input">
        <button type="submit">Hochladen</button>
    </form>
    <h2>Einstellungen:</h2>
    <form id="settings-form">
        <label for="duration">Anzeigedauer (in ms):</label>
        <input type="number" id="duration" name="duration">
        <br>
        <label for="start-time">Startzeit (HH:mm):</label>
        <input type="time" id="start-time" name="start-time">
        <br>
        <label for="end-time">Endzeit (HH:mm):</label>
        <input type="time" id="end-time" name="end-time">
        <br>
        <button type="submit">Speichern</button>
    </form>
</main>
<script>
    var currentSettings = {};

    function galleryView() {
        document.getElementById('file-list').style.flexWrap = 'wrap';
    }
    function listView() {
        document.getElementById('file-list').style.flexWrap = 'nowrap';
    }

    function updateFileList() {
        clearFileList();

        var fileList = document.getElementById('file-list');

        // AJAX-Anfrage an den Server, um die Liste der Dateien zu erhalten
        fetch('get_file_list.php')
            .then(response => response.json())
            .then(data => {
                // Fetch the file order from file_order.txt
                fetch('file_order.txt')
                    .then(response => response.text())
                    .then(orderData => {
                        const order = orderData.trim().split('\n');
                        // Sort the filenames based on the order
                        data.sort((a, b) => {
                            return order.indexOf(a) - order.indexOf(b);
                        });

                        data.forEach(filename => {
                            var container = document.createElement('div'); // Define container within the loop
                            var img = document.createElement('img');
                            container.className = 'file-container';
                            img.src = 'content/' + filename;
                            img.alt = filename;
                            img.className = 'preview';
                            container.appendChild(img);

                            var label = document.createElement('p');
                            label.textContent = filename;
                            label.className = 'label';
                            container.appendChild(label);


                            var editcontainer = document.createElement('div');

                            var leftArrowIcon = document.createElement('i');
                            leftArrowIcon.className = 'fas fa-arrow-left arrow-icon';
                            leftArrowIcon.addEventListener('click', function () {
                                moveFile(filename, 'up');
                            });
                            editcontainer.appendChild(leftArrowIcon);

                            var deleteIcon = document.createElement('i');
                            deleteIcon.className = 'fas fa-trash-alt delete-icon';
                            deleteIcon.addEventListener('click', function () {
                                if (window.confirm('Möchten Sie die Datei "' + filename + '" wirklich löschen?')) {
                                    deleteFile(filename);
                                }
                            });
                            editcontainer.appendChild(deleteIcon);

                            var rightArrowIcon = document.createElement('i');
                            rightArrowIcon.className = 'fas fa-arrow-right arrow-icon';
                            rightArrowIcon.addEventListener('click', function () {
                                moveFile(filename, 'down');
                            });
                            editcontainer.appendChild(rightArrowIcon);

                            container.appendChild(editcontainer);

                            container.dataset.filename = filename;

                            fileList.appendChild(container);
                        });
                    });
            })
            .catch(error => {
                console.error('Fehler beim Abrufen der Dateiliste: ', error);
            });
    }

    function clearFileList() {
        var fileList = document.getElementById('file-list');
        while (fileList.firstChild) {
            fileList.removeChild(fileList.firstChild);
        }
    }

    function getFilenameList() {
        var fileList = document.getElementById('file-list');
        var fileContainers = fileList.getElementsByClassName('file-container');
        var filenames = [];
        for (var i = 0; i < fileContainers.length; i++) {
            var filename = fileContainers[i].dataset.filename;
            filenames.push(filename);
        }
        return filenames;
    }

    function moveFile(filename, direction) {
    var fileList = document.getElementById('file-list');
    var fileContainers = fileList.getElementsByClassName('file-container');
    var currentIndex = -1;

    // Find the current index of the file in the file list
    for (var i = 0; i < fileContainers.length; i++) {
        if (fileContainers[i].dataset.filename === filename) {
            currentIndex = i;
            break;
        }
    }

    if (currentIndex >= 0) {
        var newIndex;
        if (direction === 'up') {
            newIndex = currentIndex - 1;
        } else if (direction === 'down') {
            newIndex = currentIndex + 1;
        } else {
            return; // Invalid direction, do nothing
        }

        if (newIndex >= 0 && newIndex < fileContainers.length) {
            // Swap the file containers in the DOM
            var currentContainer = fileContainers[currentIndex];
            var newContainer = fileContainers[newIndex];
            if (direction === 'up') {
                fileList.insertBefore(currentContainer, newContainer); // Move the current container up
            } else {
                fileList.insertBefore(newContainer, currentContainer); // Move the current container down
            }

            // Update the file order in the 'file_order.txt' file
            var filenames = getFilenameList(); // Get the updated file order from the DOM
            var filenameOrderData = JSON.stringify({ order: filenames });

            // Update the file order on the server
            fetch('update_file_order.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: filenameOrderData
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('Fehler beim Aktualisieren der Dateireihenfolge: ', error);
            });
        }
    }
    }



    function updateFileOrder(newOrder) {
    // AJAX-Anfrage an den Server, um die Dateireihenfolge zu aktualisieren
    // Hier sollten Sie Ihre serverseitige Implementierung verwenden, um die Dateireihenfolge zu speichern
    // Beispiel: 'update_file_order.php'
    fetch('update_file_order.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ order: newOrder })
    })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            updateFileList(); // Update the file list after reordering
        })
        .catch(error => {
            console.error('Fehler beim Aktualisieren der Dateireihenfolge: ', error);
        });
    }

    function deleteFile(filename) {
        // AJAX-Anfrage an den Server, um die Datei zu löschen
        // Hier sollten Sie Ihre serverseitige Implementierung verwenden, um die Datei zu löschen
        // Beispiel: 'delete_file.php'
        fetch('delete_file.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename: filename })
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                updateFileList();
            })
            .catch(error => {
                console.error('Fehler beim Löschen der Datei: ', error);
            });
    }

    document.getElementById('upload-form').addEventListener('submit', function (event) {
        event.preventDefault();
        var fileInput = document.getElementById('file-input');
        var formData = new FormData();
        formData.append('file', fileInput.files[0]);

        // AJAX-Anfrage an den Server, um die Datei hochzuladen
        // Hier sollten Sie Ihre serverseitige Implementierung verwenden, um die Datei hochzuladen
        // Beispiel: 'upload_file.php'
        fetch('upload_file.php', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                updateFileList();
            })
            .catch(error => {
                console.error('Fehler beim Hochladen der Datei: ', error);
            });
    });

    function loadSettings() {
        fetch('settings.txt')
            .then(response => response.text())
            .then(data => {
                var settings = parseSettings(data);
                populateSettingsForm(settings); // Update the settings form with fetched data
                currentSettings = settings; // Store the current settings
            })
            .catch(error => {
                console.error('Fehler beim Laden der Einstellungen: ', error);
            });
    }

    function populateSettingsForm(settings) {
        document.getElementById('duration').value = settings.duration;
        document.getElementById('start-time').value = settings.start_time;
        document.getElementById('end-time').value = settings.end_time;
    }

    function updateSettings(settings) {
        fetch('update_settings.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('Fehler beim Aktualisieren der Einstellungen: ', error);
            });
    }
    
    function parseSettings(data) {
        var settings = {};
        var lines = data.trim().split('\n');
        lines.forEach(line => {
            var parts = line.split(':');
            var key = parts[0].trim();
            var value = parts.slice(1).join(':').trim(); // Rejoin the time fields in case they contain ':'
            settings[key] = value;
        });
        return settings;
    }

    document.getElementById('settings-form').addEventListener('submit', function (event) {
        event.preventDefault();
        var duration = parseInt(document.getElementById('duration').value);
        var startTime = document.getElementById('start-time').value;
        var endTime = document.getElementById('end-time').value;

        var updatedSettings = {
            duration: duration,
            start_time: startTime,
            end_time: endTime
        };

        updateSettings(updatedSettings);
        currentSettings = updatedSettings; // Update the current settings with the new values
    });

    // Beim Laden der Seite die Dateiliste aktualisieren
    updateFileList();
    loadSettings();
</script>
</body>
</html>
